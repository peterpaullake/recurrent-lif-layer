\documentclass[12pt]{article}

%% Include math packages
\usepackage{amsfonts,amsmath,amssymb}
\usepackage{mathtools}

%% Include packages for doing figures and subfigures
\usepackage{caption}
\usepackage{subcaption}
\usepackage{float}

%% Include miscellaneous packages
\usepackage{algorithm}
\usepackage{algpseudocode}
\usepackage[a4paper, margin=1in]{geometry}
\usepackage{graphicx}
\usepackage[hidelinks]{hyperref}
\usepackage{pgf}
%% \usepackage{siunitx}
\usepackage{xcolor}

%% Define a \mathdefault command to stop pdflatex from complaining
%% when we try to include .pgf files generated by matplotlib
\newcommand{\mathdefault}[1]{#1}

%% Define a custom color for highlighting parts of equations
\definecolor{highlight}{RGB}{220, 220, 220}

%% Define commands for := and =:
%% https://tex.stackexchange.com/a/28840
\newcommand{\defeq}{\vcentcolon=}
\newcommand{\eqdef}{=\vcentcolon}

%% Define a shortcut for BrainScaleS-2
\newcommand{\bs}{BrainScaleS-2}

%% Define a shortcut for an empty list
\newcommand{\emptyList}{[\,]^\top}

%% Define shortcuts for C_m, tau_m, tau_s, and tau_ref
\newcommand{\Cm}{C_{\text{m}}}
\newcommand{\taum}{\tau_{\text{m}}}
\newcommand{\taus}{\tau_{\text{s}}}
\newcommand{\tauref}{\tau_{\text{ref}}}

%% Define a shortcut for NextOutputSpikeTime
\newcommand{\nost}{\textsc{NextOutputSpikeTime}}

\title{Notes on Recurrent LIF Layers}

\begin{document}

\maketitle

\section*{Introduction}
We introduce algorithms for calculating the forward and backward pass of a fully connected layer of LIF neurons with recurrent connections.

\section{Forward pass}
To aid in the exposition, we define the following variables:
\begin{center}
  \begin{tabular}{c c c}
    Variable name & Variable shape & Variable description \\
    \hline
    $N_{\text{in}}$ & 1 & Number of input spikes \\
    $N_{\text{post}}$ & 1 & Number of postsynaptic neurons \\
    $N_{\text{pre}}$ & 1 & Number of presynaptic neurons \\
    $\mathbf{t}$ & $N_{\text{in}}$ & Chronologically sorted input spike times \\
    $\mathbf{s}$ & $N_{\text{in}}$ & Presynaptic neuron index of each input spike \\
    $\mathbf{w}^f$ & $N_{\text{post}} \times N_{\text{pre}}$ & Feedforward synaptic weights \\
    $\mathbf{w}^r$ & $N_{\text{post}} \times N_{\text{post}}$ & Recurrent synaptic weights \\
    \hline
    $N_{\text{out}}$ & 1 & Number of output spikes \\
    $\mathbf{T}$ & $N_{\text{out}}$ & Chronologically sorted output spike times \\
    $\mathbf{S}$ & $N_{\text{out}}$ & Postsynaptic neuron index of each output spike
  \end{tabular}
\end{center}
Let
\begin{gather*}
  \underset{s}{\nost}(\mathbf{t}, \mathbf{s}, \mathbf{T}, \mathbf{S}, \mathbf{w}^f, \mathbf{w}^r, t_0, u_0, t_{\text{start}})
\end{gather*}
denote the function that, given a vector $\mathbf{t}$ of input spike times, a vector $\mathbf{s}$ of corresponding presynaptic neuron ids, a vector $\mathbf{T}$ of output spike times,\footnote{$\mathbf{T}$ is a vector of postsynaptic spike times \textit{so far}, and analogously for $\mathbf{S}$. As more output spikes are calculated, $\mathbf{T}$ and $\mathbf{S}$ are appended to.} a vector $\mathbf{S}$ of corresponding postsynaptic neuron ids, the feedforward weight matrix $\mathbf{w}^f$, the recurrent weight matrix $\mathbf{w}^r$, an initial time $t_0$ and corresponding initial membrane potential $u_0$, and an initial search time $t_{\text{start}} \geq t_0$,
%% XXX need it be subthreshold?
returns the first time $T \geq t_{\text{start}}$ such that the free membrane potential of the $s$\textsuperscript{th} postsynaptic neuron is above the threshold potential $\vartheta$, or $\infty$ if no such time exists. The details of how to evaluate \nost{} are not discussed here; we explain only how to calculate the forward pass of the LIF layer in terms of it.

The forward pass calculates the final $\mathbf{T}$ and $\mathbf{S}$ vectors given $\mathbf{t}$, $\mathbf{s}$, $\mathbf{w}^f$, and $\mathbf{w}^r$. The idea is to hop from output spike to output spike, and when an output spike is found, it gets propagated to all the neurons in the layer. \nost{} is then called for each neuron to find the earliest next output spike. This continues until all neurons are silent or a user-defined maximum number of output spikes is reached. The approach is described in detail in Algorithm \ref{forward-pass-algorithm}.

\begin{algorithm}[H]
  \caption{Calculates the output spikes of a fully connected layer of LIF neurons with recurrent connections.}
  \label{forward-pass-algorithm}
  \begin{algorithmic}
    \Procedure{RecurrentLIFLayerForward}{$\mathbf{t},\mathbf{s},\mathbf{w}^f,\mathbf{w}^r$}
    \State $\mathbf{T} \gets \emptyList$ \Comment{Output spike times}
    \State $\mathbf{S} \gets \emptyList$ \Comment{Output spike neuron ids}
    \State $\mathbf{T}_{\text{prev}} \gets [\underbrace{-\infty, -\infty, \ldots, -\infty}_{\text{$N_{\text{post}}$ many}}]^\top$ \Comment{Most recent spike time of each neuron}
    \State $t \gets \operatorname{min}(\mathbf{t})$ \Comment{Start the search at the earliest input spike}
    \While{$\texttt{len}(\mathbf{T}) < \text{maximum output spikes}$}
    \State $T \gets \infty$ \Comment{Next output spike time}
    \State $S \gets -1$ \Comment{Next output spike neuron id}
    \For{$s = 1, 2, \ldots, N_{\text{post}}$} \Comment{Query each neuron to find the next output spike}
    \State $T_{\text{prev}} \gets \textbf{T}_{\text{prev}}$\texttt{[$s$]}
    \If{\texttt{isinf}$(T_{\text{prev}})$}
    \State $T_{\text{neuron}} \gets \underset{s}{\nost}(\mathbf{t}, \mathbf{s}, \mathbf{T}, \mathbf{S}, \mathbf{w}^f, \mathbf{w}^r, \text{min}(\mathbf{t}), 0, t)$
    \Else
    \State $t_{\text{remaining}} \gets \tauref - (t - T_{\text{prev}})$ \Comment{Calculate remaining refractory time}
    \If{$t_{\text{remaining}} < 0$}
    \State $t_{\text{remaining}} \gets 0$
    \EndIf
    \State $T_{\text{neuron}} \gets \underset{s}{\nost}($\parbox[t]{\linewidth}{$\mathbf{t}, \mathbf{s}, \\ \mathbf{T}, \mathbf{S}, \\ \mathbf{w}^f, \mathbf{w}^r, \\ T_{\text{prev}} + \tauref, \varrho, \\ t + t_{\text{remaining}})$}
    \EndIf
    \If{\texttt{isinf}$(T)$ \textbf{or} $T_{\text{neuron}} < T$} \Comment{Find the neuron that fires first}
    \State $T \gets T_{\text{neuron}}$
    \State $S \gets s$
    \EndIf
    \EndFor
    \If{\texttt{isinf}$(T)$} \Comment{Terminate if no neuron fired}
    \State \textbf{break}
    \EndIf
    \State $\mathbf{T} \gets \mathbf{T} + [T]^\top$ \Comment{Save the output spike time}
    \State $\mathbf{S} \gets \mathbf{S} + [S]^\top$ \Comment{Save the output spike neuron id}
    \State $\mathbf{T}_{\text{prev}}$\texttt{[$S$]} $\gets T$ \Comment{Update the most recent spike time of the neuron that fired}
    \State $t \gets T$ \Comment{Continue the search starting at the output spike}
    \EndWhile
    \State \Return $\mathbf{T}, \mathbf{S}$
    \EndProcedure
  \end{algorithmic}
\end{algorithm}

\section{Backward pass}
Todo: write this section.
\newpage

\section{Experiments}

\subsection{Neuron impulse response}
\begin{figure}[H]
  \centering
  \graphicspath{{../visualizations/single-neuron-impulse-response/report}}
  \input{../visualizations/single-neuron-impulse-response/report/single-neuron-impulse-response.pgf}
  \caption{Number of emitted spikes of a LIF neuron in response to a single input spike as a function of the feedforward weight $w^r$ and the recurrent weight $w^f$.}
  \label{impulse-response-figure}
\end{figure}

\subsection{Membrane dynamics in different regimes}
\begin{figure}[H]
  \centering
  \input{../visualizations/regime-comparison/report/regime-comparison.pgf}
  \caption{Membrane potentials of a 3-neuron recurrent LIF layer in response to the same stimulus for three different regimes. \textbf{a)} Single-spike without recurrence: neurons are allowed to fire only once, and the timing of the output spikes is not affected by previous output spikes. \textbf{b)} Multi-spike without recurrence: neurons are allowed to fire arbitrarily many times, and the timing of the output spikes is not affected by previous output spikes. %% XXX up to a user-specified maximum
    \textbf{c)} Multi-spike with recurrence: neurons are allowed to fire arbitrarily many times, and the output spikes are fed back into the synapses. In this case, the recurrent weights are highly inhibitory, which causes the first-firing neuron (blue) to inhibit the other neurons (red and green) from firing.}
  \label{regime-comparison-figure}
\end{figure}

\subsection{Training on MNIST in different regimes}
\begin{figure}[H]
  \centering
  \input{../visualizations/training-comparison/report/training-comparison.pgf}
  \caption{Training a 256-32-10 fully connected SNN on MNIST for 50 epochs.}
  \label{training-comparison-figure}
\end{figure}

\end{document}
